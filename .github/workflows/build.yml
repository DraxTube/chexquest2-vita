name: Build Chex Quest 2 PS Vita VPK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: vitasdk/vitasdk:latest

    steps:
      - name: Install dependencies
        run: |
          apk add --no-cache git cmake make bash zip wget python3

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone doomgeneric
        run: |
          git clone --depth 1 https://github.com/ozkl/doomgeneric.git doomgeneric_src

      - name: Prepare source tree
        run: |
          mkdir -p build_src

          # Copy doomgeneric sources
          cp doomgeneric_src/doomgeneric/*.c build_src/
          cp doomgeneric_src/doomgeneric/*.h build_src/

          # Remove ALL platform-specific backends - keep ONLY our vita one
          rm -f build_src/doomgeneric_sdl.c
          rm -f build_src/doomgeneric_win.c
          rm -f build_src/doomgeneric_xlib.c
          rm -f build_src/doomgeneric_ascii.c
          rm -f build_src/doomgeneric_sokol.c
          rm -f build_src/doomgeneric_null.c
          rm -f build_src/doomgeneric_allegro.c
          rm -f build_src/doomgeneric_emscripten.c

          # Catch any future platform files we might miss
          # Remove everything matching doomgeneric_*.c EXCEPT doomgeneric.c
          cd build_src
          for f in doomgeneric_*.c; do
            case "$f" in
              doomgeneric.c) ;; # keep the core file
              *) rm -f "$f" ;;
            esac
          done
          cd ..

          # Remove original i_sound.c (we provide our own)
          rm -f build_src/i_sound.c

          # Copy our Vita implementation
          cp src/doomgeneric_vita.c build_src/
          cp src/i_sound_vita.c build_src/i_sound.c

      - name: Fix main() conflict and Vita patches
        run: |
          cd build_src

          # Remove main() from doomgeneric.c - we provide our own in doomgeneric_vita.c
          python3 << 'PYEOF'
          import re

          with open("doomgeneric.c", "r") as f:
              content = f.read()

          # Replace 'int main(' with 'int doomgeneric_original_main(' to avoid duplicate symbol
          if 'int main(' in content:
              content = content.replace('int main(', 'int doomgeneric_original_main(')

          with open("doomgeneric.c", "w") as f:
              f.write(content)
          PYEOF

          # Patch i_system.c - replace exit() with sceKernelExitProcess
          if [ -f "i_system.c" ]; then
            sed -i '1i\#ifdef VITA\n#include <psp2/kernel/processmgr.h>\n#define exit(x) sceKernelExitProcess(x)\n#endif' i_system.c
          fi

          # Patch d_iwad.c - redirect WAD search path
          if [ -f "d_iwad.c" ]; then
            sed -i 's|getenv("DOOMWADDIR")|"ux0:data/chexquest2"|g' d_iwad.c 2>/dev/null || true
            sed -i 's|getenv("HOME")|"ux0:data/chexquest2"|g' d_iwad.c 2>/dev/null || true
          fi

          # Patch m_misc.c - redirect config/save path
          if [ -f "m_misc.c" ]; then
            sed -i 's|getenv("HOME")|"ux0:data/chexquest2"|g' m_misc.c 2>/dev/null || true
          fi

          # Ensure i_timer.c has sys/time.h
          if [ -f "i_timer.c" ]; then
            grep -q "sys/time.h" i_timer.c || sed -i '1i\#include <sys/time.h>' i_timer.c
          fi

          # Stub out i_net.c for Vita (no networking)
          if [ -f "i_net.c" ]; then
            cat > i_net.c << 'NETEOF'
          #include "doomtype.h"
          void I_InitNetwork(void) {}
          void I_NetCmd(void) {}
          NETEOF
          fi

          cd ..

      - name: Create sce_sys assets
        run: |
          mkdir -p sce_sys/livearea/contents

          python3 << 'PYEOF'
          import struct, zlib

          def create_png(w, h, r, g, b):
              def chunk(ctype, data):
                  c = ctype + data
                  return struct.pack('>I', len(data)) + c + struct.pack('>I', zlib.crc32(c) & 0xffffffff)
              raw = b''
              for y in range(h):
                  raw += b'\x00'
                  for x in range(w):
                      cr = min(255, r + (x * 50 // w))
                      cg = min(255, g + (y * 30 // h))
                      cb = b
                      raw += bytes([cr, cg, cb])
              return (b'\x89PNG\r\n\x1a\n' +
                      chunk(b'IHDR', struct.pack('>IIBBBBB', w, h, 8, 2, 0, 0, 0)) +
                      chunk(b'IDAT', zlib.compress(raw, 9)) +
                      chunk(b'IEND', b''))

          with open('sce_sys/icon0.png', 'wb') as f:
              f.write(create_png(128, 128, 20, 120, 20))

          with open('sce_sys/livearea/contents/bg.png', 'wb') as f:
              f.write(create_png(840, 500, 10, 60, 10))
          PYEOF

          cat > sce_sys/livearea/contents/template.xml << 'XMLEOF'
          <?xml version="1.0" encoding="utf-8"?>
          <livearea style="a1" format-ver="01.00" content-rev="1">
            <livearea-bg>
              <image>bg.png</image>
            </livearea-bg>
            <gate>
              <startup-image>bg.png</startup-image>
            </gate>
          </livearea>
          XMLEOF

      - name: List build_src contents for debug
        run: |
          echo "=== Files in build_src ==="
          ls -la build_src/doomgeneric*.c 2>/dev/null || echo "no doomgeneric_*.c files"
          echo "=== All .c files ==="
          ls build_src/*.c | head -60
          echo "=== Total ==="
          ls build_src/*.c | wc -l

      - name: Build with CMake
        run: |
          mkdir -p build && cd build
          cmake -DCMAKE_TOOLCHAIN_FILE="${VITASDK}/share/vita.toolchain.cmake" \
                -DCMAKE_BUILD_TYPE=Release \
                ..
          make -j$(nproc) VERBOSE=1

      - name: Verify VPK
        run: |
          ls -la build/*.vpk
          echo "Build successful!"

      - name: Upload VPK
        uses: actions/upload-artifact@v4
        with:
          name: ChexQuest2-Vita-VPK
          path: build/*.vpk
          if-no-files-found: error
