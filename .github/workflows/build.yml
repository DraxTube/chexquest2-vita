name: Build Chex Quest 2 Vita

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: vitasdk/vitasdk:latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Clone doomgeneric
      run: |
        git clone --depth 1 https://github.com/ozkl/doomgeneric.git doomgeneric_repo
        mv doomgeneric_repo/doomgeneric ./doomgeneric
        rm -rf doomgeneric_repo

    - name: Patch doomgeneric for Vita
      run: |
        # Patch per rimuovere dipendenze SDL
        cd doomgeneric
        
        # Crea stub per i_sound se necessario
        cat > i_sound_stub.c << 'SOUND_EOF'
        #include "i_sound.h"
        #include "doomtype.h"
        
        boolean I_SDL_InitSound(boolean use_sfx_prefix) { return true; }
        void I_SDL_ShutdownSound(void) {}
        int I_SDL_GetSfxLumpNum(sfxinfo_t *sfx) { return 0; }
        void I_SDL_UpdateSound(void) {}
        void I_SDL_UpdateSoundParams(int channel, int vol, int sep) {}
        int I_SDL_StartSound(sfxinfo_t *sfx, int channel, int vol, int sep, int pitch) { return 0; }
        void I_SDL_StopSound(int channel) {}
        boolean I_SDL_SoundIsPlaying(int channel) { return false; }
        void I_SDL_PrecacheSounds(sfxinfo_t *sounds, int num_sounds) {}
        
        boolean I_SDL_InitMusic(void) { return true; }
        void I_SDL_ShutdownMusic(void) {}
        void I_SDL_SetMusicVolume(int vol) {}
        void I_SDL_PlaySong(void *data, boolean loop) {}
        void I_SDL_PauseSong(void) {}
        void I_SDL_ResumeSong(void) {}
        void I_SDL_StopSong(void) {}
        boolean I_SDL_MusicIsPlaying(void) { return false; }
        void I_SDL_PollMusic(void) {}
        SOUND_EOF
        
        cd ..

    - name: Create sce_sys directory structure
      run: |
        mkdir -p sce_sys/livearea/contents
        
        # Crea icon0.png placeholder (128x128 PNG)
        apt-get update && apt-get install -y imagemagick
        convert -size 128x128 xc:#00AA00 -fill white -gravity center \
          -pointsize 20 -annotate 0 'CHEX\nQUEST 2' sce_sys/icon0.png
        
        # Crea bg.png (840x500)
        convert -size 840x500 xc:#004400 -fill white -gravity center \
          -pointsize 40 -annotate 0 'CHEX QUEST 2\nPS VITA' sce_sys/livearea/contents/bg.png
        
        # Crea startup.png (280x158)  
        convert -size 280x158 xc:#006600 -fill white -gravity center \
          -pointsize 16 -annotate 0 'START' sce_sys/livearea/contents/startup.png
        
        # Crea template.xml
        cat > sce_sys/livearea/contents/template.xml << 'TEMPLATE_EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <livearea style="a1" format-ver="01.00" content-rev="1">
          <livearea-background>
            <image>bg.png</image>
          </livearea-background>
          <gate>
            <startup-image>startup.png</startup-image>
          </gate>
        </livearea>
        TEMPLATE_EOF

    - name: Build VPK
      run: |
        mkdir build && cd build
        cmake ..
        make -j$(nproc)

    - name: Upload VPK artifact
      uses: actions/upload-artifact@v4
      with:
        name: chexquest2-vita-vpk
        path: build/*.vpk
        if-no-files-found: error

    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        files: build/*.vpk
        body: |
          ## Chex Quest 2 per PS Vita
          
          ### Installazione:
          1. Scarica il file VPK
          2. Installalo con VitaShell
          3. Copia `chex2.wad` in `ux0:data/chexquest2/`
          4. Avvia il gioco!
          
          ### Controlli:
          - Analog sinistro: Movimento
          - Analog destro: Strafe
          - X: Usa/Apri
          - O / R: Spara
          - L: Corri
          - Start: Menu
          - Select: Mappa
          - Touch (alto): Cambia arma
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
