name: Build Chex Quest 2 Vita

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make build-essential

      - name: Install VitaSDK
        run: |
          export VITASDK=/usr/local/vitasdk
          export PATH="$VITASDK/bin:$PATH"
          git clone https://github.com/vitasdk/vdpm
          cd vdpm
          ./bootstrap-vitasdk.sh
          echo "VITASDK=$VITASDK" >> $GITHUB_ENV
          echo "$VITASDK/bin" >> $GITHUB_PATH

      - name: Install Vita libraries
        run: |
          vdpm vita2d
          vdpm libpng
          vdpm libjpeg-turbo
          vdpm zlib

      - name: Verify toolchain
        run: |
          echo "VITASDK=$VITASDK"
          which arm-vita-eabi-gcc
          arm-vita-eabi-gcc --version
          ls $VITASDK/share/vita.cmake

      - name: Build
        run: |
          mkdir -p build && cd build
          cmake -DCMAKE_TOOLCHAIN_FILE=$VITASDK/share/vita.cmake ..
          make -j$(nproc)

      - name: Upload VPK
        uses: actions/upload-artifact@v4
        with:
          name: ChexQuest2-VPK
          path: build/ChexQuest2.vpk
